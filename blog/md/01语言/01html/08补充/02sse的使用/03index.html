<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE (Server-Sent Events) 实时演示</title>
    <!-- 引入 Chart.js 用于图表绘制 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Google Style Guide: 2-space indentation, property ordering */
        :root {
            --bg-color: #f4f7f9;
            --main-color: #ffffff;
            --border-color: #e0e0e0;
            --text-color: #333;
            --primary-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            font-family: var(--font-family);
            justify-content: center;
            margin: 0;
            padding: 2rem;
        }
        .container {
            background-color: var(--main-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            max-width: 900px;
            padding: 2rem;
            width: 100%;
        }
        h1 {
            border-bottom: 2px solid var(--border-color);
            color: var(--primary-color);
            margin-top: 0;
            padding-bottom: 1rem;
            text-align: center;
        }
        .controls {
            align-items: center;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        .status {
            align-items: center;
            display: flex;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .status-indicator {
            border-radius: 50%;
            height: 12px;
            margin-right: 0.75rem;
            transition: background-color 0.3s ease;
            width: 12px;
        }
        .status-indicator.disconnected { background-color: var(--danger-color); }
        .status-indicator.connecting { background-color: var(--warning-color); }
        .status-indicator.connected { background-color: var(--success-color); }
        .buttons button {
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.6rem 1.2rem;
            transition: background-color 0.2s, opacity 0.2s;
        }
        #startBtn { background-color: var(--success-color); }
        #stopBtn { background-color: var(--danger-color); }
        .buttons button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .content-grid {
            display: grid;
            gap: 2rem;
            grid-template-columns: 1fr 1fr;
        }
        .log-container, .chart-container {
            background: #fafafa;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
        }
        h2 {
            color: #555;
            font-size: 1.2rem;
            margin-top: 0;
        }
        #log {
            background-color: #2d3436;
            border-radius: 4px;
            color: #dfe6e9;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            height: 300px;
            overflow-y: auto;
            padding: 0.8rem;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-entry { margin-bottom: 0.5rem; }
        .log-entry.info { color: #55efc4; }
        .log-entry.event { color: #74b9ff; }
        .log-entry.error { color: #fab1a0; }
        /* Responsive layout for smaller screens */
        @media (max-width: 768px) {
            .content-grid { grid-template-columns: 1fr; }
            .controls {
                align-items: stretch;
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Page Header -->
    <h1>SSE (Server-Sent Events) 实时演示</h1>

    <!-- Connection Controls -->
    <div class="controls">
        <div class="status">
            <div id="statusIndicator" class="status-indicator disconnected"></div>
            <span id="statusText">已断开</span>
        </div>
        <div class="buttons">
            <button id="startBtn">▶️ 开始连接</button>
            <button id="stopBtn" disabled>⏹️ 断开连接</button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="content-grid">
        <div class="log-container">
            <h2>实时事件日志</h2>
            <div id="log"></div>
        </div>
        <div class="chart-container">
            <h2>实时系统状态图表</h2>
            <canvas id="systemChart"></canvas>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        /**
         * Constants for magic strings and configuration.
         * @const
         */
        const CONSTANTS = {
            SSE_ENDPOINT: '/sse',
            MAX_CHART_POINTS: 15,
            EVENT_WELCOME: 'welcome',
            EVENT_SYSTEM_UPDATE: 'system_update',
            STATUS_CLASS: {
                CONNECTED: 'connected',
                CONNECTING: 'connecting',
                DISCONNECTED: 'disconnected',
            },
            LOG_TYPE: {
                INFO: 'info',
                EVENT: 'event',
                ERROR: 'error',
            },
        };

        // DOM Element references
        const startBtnEl = document.getElementById('startBtn');
        const stopBtnEl = document.getElementById('stopBtn');
        const statusIndicatorEl = document.getElementById('statusIndicator');
        const statusTextEl = document.getElementById('statusText');
        const logEl = document.getElementById('log');
        const chartCanvasEl = document.getElementById('systemChart');

        let eventSource = null;
        let chart = null;

        // --- UI Update Functions ---

        /**
         * Updates the connection status display.
         * @param {string} text - The text to display.
         * @param {string} statusClass - The CSS class for the indicator.
         */
        const updateStatus = (text, statusClass) => {
            statusTextEl.textContent = text;
            statusIndicatorEl.className = `status-indicator ${statusClass}`;
        };

        /**
         * Appends a message to the log container.
         * @param {string} message - The message to log.
         * @param {string} type - The type of log entry for styling.
         */
        const logMessage = (message, type = CONSTANTS.LOG_TYPE.INFO) => {
            const entryEl = document.createElement('div');
            entryEl.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entryEl.textContent = `[${timestamp}] ${message}`;
            logEl.appendChild(entryEl);
            // Auto-scroll to the bottom
            logEl.scrollTop = logEl.scrollHeight;
        };

        /**
         * Toggles the enabled/disabled state of control buttons.
         * @param {boolean} isConnected - True if the connection is active.
         */
        const toggleButtons = (isConnected) => {
            startBtnEl.disabled = isConnected;
            stopBtnEl.disabled = !isConnected;
        };


        // --- Chart.js Initialization and Update ---

        /**
         * Initializes the Chart.js line chart.
         */
        const initChart = () => {
            if (chart) {
                chart.destroy();
            }
            const ctx = chartCanvasEl.getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU 使用率 (%)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                    }, {
                        label: '内存使用率 (%)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                    }],
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: '使用率 (%)' },
                        },
                        x: {
                            title: { display: true, text: '时间' },
                        },
                    },
                    animation: {
                        duration: 200, // Smooth animation
                    },
                },
            });
        };

        /**
         * Updates the chart with new data from an event.
         * @param {object} data - The data object containing timestamp, cpu, and memory.
         */
        const updateChart = (data) => {
            if (!chart) return;

            chart.data.labels.push(data.timestamp);
            chart.data.datasets[0].data.push(data.cpu);
            chart.data.datasets[1].data.push(data.memory);

            // Remove old data to keep the chart clean
            if (chart.data.labels.length > CONSTANTS.MAX_CHART_POINTS) {
                chart.data.labels.shift();
                chart.data.datasets.forEach(dataset => dataset.data.shift());
            }

            chart.update();
        };

        // --- SSE Core Logic ---

        /**
         * Starts the Server-Sent Events connection and sets up listeners.
         */
        const startSSE = () => {
            if (eventSource) return;

            eventSource = new EventSource(CONSTANTS.SSE_ENDPOINT);
            updateStatus('连接中...', CONSTANTS.STATUS_CLASS.CONNECTING);
            logMessage('正在尝试连接到服务器...', CONSTANTS.LOG_TYPE.INFO);
            toggleButtons(true);

            // 1. On successful connection
            eventSource.onopen = () => {
                updateStatus('已连接', CONSTANTS.STATUS_CLASS.CONNECTED);
                logMessage('SSE 连接已成功建立！', CONSTANTS.LOG_TYPE.INFO);
            };

            // 2. On connection error
            eventSource.onerror = () => {
                // The browser automatically tries to reconnect, setting readyState to CONNECTING
                if (eventSource.readyState === EventSource.CONNECTING) {
                    updateStatus('正在重连...', CONSTANTS.STATUS_CLASS.CONNECTING);
                    logMessage('连接已断开，正在自动重连...', CONSTANTS.LOG_TYPE.ERROR);
                } else {
                    logMessage('发生不可恢复的错误，连接关闭。', CONSTANTS.LOG_TYPE.ERROR);
                    stopSSE();
                }
            };

            // 3. Listen for the custom 'welcome' event
            eventSource.addEventListener(CONSTANTS.EVENT_WELCOME, (event) => {
                logMessage(`服务器消息: ${event.data}`, CONSTANTS.LOG_TYPE.INFO);
            });

            // 4. Listen for the custom 'system_update' event
            eventSource.addEventListener(CONSTANTS.EVENT_SYSTEM_UPDATE, (event) => {
                try {
                    const data = JSON.parse(event.data);
                    const message = `接收到 [system_update]: CPU ${data.cpu}%, 内存 ${data.memory}%`;
                    logMessage(message, CONSTANTS.LOG_TYPE.EVENT);
                    updateChart(data);
                } catch (error) {
                    logMessage('解析服务器数据失败。', CONSTANTS.LOG_TYPE.ERROR);
                    console.error('Failed to parse JSON from event:', event.data, error);
                }
            });
        };

        /**
         * Closes the SSE connection and resets the state.
         */
        const stopSSE = () => {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                updateStatus('已断开', CONSTANTS.STATUS_CLASS.DISCONNECTED);
                logMessage('连接已由用户手动关闭。', CONSTANTS.LOG_TYPE.INFO);
                toggleButtons(false);
            }
        };

        // --- Event Listeners and Initialization ---
        startBtnEl.addEventListener('click', startSSE);
        stopBtnEl.addEventListener('click', stopSSE);

        // Initial page setup
        initChart();
        logMessage('页面加载完成。点击 "开始连接" 接收实时数据。', 'info');
    });
</script>

</body>
</html>