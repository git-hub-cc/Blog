**角色:** 解决方案架构师

**工作流程:**
你将收到**新的产品愿景** `{{USER_VISION}}` 以及项目的**当前V3版本完整代码** `{{EXISTING_CODE}}`。请分析这些非常高级的需求，并输出一份**V4.0版本的技术实现蓝图**。

1.  **需求分析**: 将宏大的愿景拆解为两个独立的技术挑战。
2.  **架构设计 (联邦网络)**: 提出一个完整、健壮的服务器间通信架构。这必须包括节点发现、身份认证、消息路由和状态同步的机制。
3.  **架构设计 (AI工具调用)**: 设计一个通用的AI工具调用协议（代号MCP），并规划其在后端服务中的实现流程。
4.  **前端修改/新增**: 规划为支持新功能所需的前端UI和逻辑变更。
5.  **后端修改/新增**: 规划实现联邦网络和MCP所需的所有后端Java类和服务。
6.  **配置与部署**: 说明需要如何修改配置文件以支持新架构。

**你的任务是输出这份高级功能的实现蓝图。**

---
**{{USER_VISION}}**
我的朋友也想部署一个这样的网站，我们能把我们的服务器连起来吗？这样我的用户就能和他那边的用户聊天了。另外，我的AI角色虽然会聊天，但还是有点像个‘书呆子’，能不能让它帮我做点实际的事情？比如我问‘北京天气怎么样’，它能真的去查一下然后告诉我。

---
**{{EXISTING_CODE}}**
*(此处粘贴第三部分生成的全部V3代码)*


**角色:** 全栈开发专家

**核心指令:**
你将收到一份**V4.0版本的技术实现蓝图** `{{BLUEPRINT}}` 和项目的**V3版本完整代码** `{{EXISTING_CODE}}`。

你的任务是：**严格按照V4.0蓝图的要求，对V3代码进行架构级的重构和功能添加，以实现联邦网络和AI工具调用能力。**

**执行准则:**
1.  **后端重构**:
    *   创建`ServerIdentityService`, `FederationRoutingService`, `FederationService`。
    *   重构`SignalingWebSocketHandler`和`UserSessionService`以支持联邦逻辑。
    *   重构`OpenAIServiceImpl`以实现MCP两阶段调用。
    *   添加所有新的DTO和配置Properties类。
    *   更新`application.yml`以包含新配置。
2.  **前端修改**:
    *   重构`PeopleLobby.vue`以显示全网用户。
    *   为MCP助手创建新的主题和数据文件。
    *   在`MessageBubble.vue`中添加对“AI思考中/使用工具中”状态的UI展示。
3.  **代码质量**: 这是一个复杂的重构，必须确保所有模块之间的依赖关系和调用逻辑正确无误。

**现在，请输出所有被修改或新增的文件内容。**

---
**{{BLUEPRINT}}**
*(此处粘贴上面的 V4.0 技术实现蓝图)*

---
**{{EXISTING_CODE}}**
*(此处粘贴第三部分生成的全部V3代码)*
